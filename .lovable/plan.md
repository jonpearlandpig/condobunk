

# Auto-Notify Venue Box Office on Guest List Approval

## The Gap

Right now: Crew texts request -> auto-approved -> crew gets SMS with pickup info. But the venue box office has NO idea these guests are coming. The TA still has to manually relay the list -- breaking the zero-touch promise.

## The Solution: Box Office Contact + Auto-Email/SMS

Each allotment gets an optional **box office contact** (email and/or phone). When a request is auto-approved (or TA-approved), the system automatically notifies the box office with the updated guest list for that show. No human in the middle.

## How It Works

```text
Crew texts: "Guest list tomorrow: John Smith +1"
                      |
             Auto-approved (tickets available)
                      |
           +----------+----------+
           |                     |
    SMS to crew              Box office contact
    "You're on the list!     configured?
     Will Call under..."          |
                          +------+------+
                          |             |
                        Email?        Phone?
                          |             |
                   Send formatted    Send SMS with
                   guest list        updated names
                   via edge fn       via Twilio
```

## What the TA Configures (per allotment)

In the allotment editor dialog, add a "Box Office Contact" section:

- **Box Office Email** -- e.g., boxoffice@bridgestonearena.com
- **Box Office Phone** -- for venues that prefer text
- **Auto-Notify** toggle -- on/off (default on when contact is provided)

This is per-show, because every venue has a different box office contact.

## What Gets Sent to the Box Office

### Email (via edge function using Resend or similar)

```
Subject: Guest List Update - [Tour Name] - [Date]

Guest List for [Tour Name]
[Venue] - [Date]

1. John Smith +1 (2 tickets) - Requested by Mike (Audio)
2. Sarah Miller (1 ticket) - Requested by Lisa (Video)

Total: 3 guests, 3 tickets
Pickup: Will Call under tour name

---
Auto-generated by Condo Bunk TourText
```

### SMS (via Twilio, for venues that prefer text)

```
Guest List Update - [Tour Name] [Date]:
John Smith +1 (2 tix, req by Mike)
Sarah Miller (1 tix, req by Lisa)
Total: 3 tix. Will Call under tour name.
```

## Key Design Decision: Send Full List vs. Incremental

**Send the full updated list every time**, not just the new addition. Box offices want ONE definitive list, not a stream of individual adds. Each notification replaces the previous one. This also handles the case where a TA edits or removes someone -- the box office always has the current truth.

## Technical Changes

### 1. Database: Add columns to `guest_list_allotments`

```sql
ALTER TABLE guest_list_allotments
ADD COLUMN box_office_email text,
ADD COLUMN box_office_phone text,
ADD COLUMN auto_notify_box_office boolean NOT NULL DEFAULT false;
```

No new tables. No new RLS policies needed (same TA/MGMT controls apply).

### 2. Edge Function: `guest-list-request/index.ts`

After any successful approval (auto or TA-manual):

1. Check if the allotment has `auto_notify_box_office = true` and has an email or phone
2. Fetch ALL approved requests for this allotment
3. Build the formatted guest list
4. If email: call a new `notify-box-office` edge function (sends email via the Lovable AI gateway or a simple SMTP/API call)
5. If phone: send SMS via existing Twilio integration
6. Log the outbound notification

### 3. New Edge Function: `notify-box-office/index.ts`

Handles sending the formatted guest list email. Uses a simple HTML email template with the full guest list, tour name, venue, date, and pickup instructions. This keeps email logic separate from the approval logic.

For email sending, we have two options:
- If you already have Resend configured, use that
- Otherwise, use the Twilio SendGrid API (same Twilio account) or we can set up Resend

### 4. Frontend: `GuestListManager.tsx`

Add to the allotment editor dialog:

- "Box Office Contact" section with email and phone inputs
- "Auto-Notify" toggle (auto-enables when email or phone is entered)
- On allotment cards, show a small indicator when auto-notify is active (e.g., a bell icon)

### 5. `tourtext-inbound` -- No Changes

The inbound flow stays the same. The box office notification is triggered from `guest-list-request` after approval, not from the SMS handler.

## Notification Timing

| Event | Crew SMS | Box Office Notification |
|-------|----------|------------------------|
| Auto-approved | Immediate confirmation | Full updated list sent |
| TA approves from Admin | Immediate confirmation | Full updated list sent |
| TA denies / "next time" | Denial SMS | No notification (nothing changed) |
| TA edits allotment | -- | Optional: re-send current list |

## Files Summary

| File | Action | Purpose |
|------|--------|---------|
| Migration SQL | Create | Add 3 columns to `guest_list_allotments` |
| `supabase/functions/guest-list-request/index.ts` | Modify | After approval, trigger box office notification |
| `supabase/functions/notify-box-office/index.ts` | Create | Send formatted guest list email/SMS to venue |
| `src/components/bunk/GuestListManager.tsx` | Modify | Add box office contact fields to allotment editor |

## What This Achieves

The complete zero-touch flow becomes:

1. TA sets up allotment with box office contact (once per show)
2. Crew texts TourText with guest request
3. System auto-approves if tickets available
4. Crew gets SMS confirmation with pickup info
5. Box office gets updated guest list automatically
6. Nobody touches anything. It just works.

